<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeRoads - Municipality Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .active-tab {
            border-bottom: 2px solid #60a5fa;
            color: #60a5fa;
        }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-slate-800 border-b border-slate-700 px-6 py-4 flex justify-between items-center shadow-md z-20">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                SafeRoads Admin</h1>
            <span
                class="px-2 py-0.5 rounded text-xs bg-slate-700 text-gray-300 border border-slate-600">Municipality</span>
        </div>
        <button onclick="API.logout()" class="text-gray-400 hover:text-white transition-colors">
            <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
    </nav>

    <!-- Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar / List -->
        <div class="w-full md:w-1/3 lg:w-96 bg-slate-800/80 border-r border-slate-700 flex flex-col z-10">
            <!-- Tabs -->
            <div class="flex border-b border-slate-700">
                <button onclick="switchTab('automated')" id="tab-automated"
                    class="flex-1 py-3 text-sm font-medium text-gray-400 hover:bg-slate-700 transition-colors active-tab">
                    Priority List
                </button>
                <button onclick="switchTab('manual')" id="tab-manual"
                    class="flex-1 py-3 text-sm font-medium text-gray-400 hover:bg-slate-700 transition-colors">
                    Manual Reports
                </button>
            </div>

            <!-- List Container -->
            <div id="complaintList" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Items populated via JS -->
            </div>
        </div>

        <!-- Main View (Map + Details) -->
        <div class="hidden md:flex flex-1 relative bg-slate-900 flex-col">
            <div id="map" class="flex-1 w-full h-full z-0"></div>

            <!-- Floating Details Panel -->
            <div id="detailsPanel"
                class="absolute bottom-6 left-6 right-6 bg-slate-800/95 backdrop-blur-md border border-slate-600 rounded-xl p-6 shadow-2xl transform translate-y-[120%] transition-transform duration-300 z-10 flex gap-6">
                <!-- Video Section -->
                <div class="w-1/3 aspect-video bg-black rounded-lg overflow-hidden relative group">
                    <video id="detailVideo" controls class="w-full h-full object-cover"></video>
                    <div id="noVideoMsg"
                        class="absolute inset-0 flex items-center justify-center text-gray-500 text-sm">No Video</div>
                </div>

                <!-- Info Section -->
                <div class="flex-1">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h2 id="detailRoad" class="text-xl font-bold">Road Name</h2>
                            <p id="detailLoc" class="text-sm text-gray-400 font-mono">Lat, Long</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-400" id="detailScore">0.0</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wider">Priority Score</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 my-4 text-sm">
                        <div class="bg-slate-700/50 p-2 rounded">
                            <span class="text-gray-400 block text-xs">Potholes Detected</span>
                            <span id="detailPotholes" class="font-medium text-white">0</span>
                        </div>
                        <div class="bg-slate-700/50 p-2 rounded">
                            <span class="text-gray-400 block text-xs">Status</span>
                            <span id="detailStatus" class="font-medium text-yellow-400 uppercase">Pending</span>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button onclick="updateStatus('approved')"
                            class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded text-sm font-medium transition-colors">Approve
                            for Repair</button>
                        <button onclick="updateStatus('fixed')"
                            class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded text-sm font-medium transition-colors">Mark
                            Fixed</button>
                        <button onclick="updateStatus('rejected')"
                            class="flex-1 bg-red-600/20 text-red-400 hover:bg-red-600/30 py-2 rounded text-sm font-medium transition-colors">Reject</button>
                    </div>
                </div>
                <button onclick="closeDetails()" class="absolute top-2 right-2 text-gray-400 hover:text-white"><i
                        data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
    </div>

    <script src="static/js/api.js"></script>
    <script>
        lucide.createIcons();
        if (localStorage.getItem('role') !== 'employee') window.location.href = 'login.html';

        let map, markers = [];
        let allComplaints = [];
        let currentTab = 'automated';
        let selectedId = null;

        // Init Map
        function initMap() {
            map = L.map('map').setView([12.9716, 77.5946], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
        }

        function renderList() {
            const listContainer = document.getElementById('complaintList');
            let filtered = allComplaints.filter(c => c.type === currentTab);

            // Sort: Automated by priority desc, Manual by Date desc
            if (currentTab === 'automated') {
                filtered.sort((a, b) => b.priority_score - a.priority_score);
            } else {
                filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }

            listContainer.innerHTML = filtered.map(c => `
                <div onclick="selectComplaint(${c.id})" 
                     class="p-4 rounded-lg cursor-pointer transition-all border border-transparent hover:bg-slate-700/50 ${selectedId === c.id ? 'bg-slate-700 border-blue-500/50 shadow-lg' : 'bg-slate-800'}">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-medium truncate pr-2">${c.road_name || 'Unknown Road'}</h3>
                        ${currentTab === 'automated' ? `<span class="text-blue-400 font-bold text-sm">${c.priority_score.toFixed(1)}</span>` : ''}
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-400">
                        <span>#${c.id} â€¢ ${new Date(c.created_at).toLocaleDateString()}</span>
                        <span class="${c.status === 'pending' ? 'text-yellow-400' :
                    c.status === 'approved' ? 'text-blue-400' :
                        c.status === 'fixed' ? 'text-green-400' : 'text-red-400'
                }">${c.status}</span>
                    </div>
                </div>
            `).join('');

            // Update Map Markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            filtered.forEach(c => {
                if (c.location) {
                    const [lat, lng] = c.location.split(',').map(Number);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng]).addTo(map)
                            .bindPopup(`<b>${c.road_name}</b><br>Priority: ${c.priority_score}<br>Status: ${c.status}`)
                            .on('click', () => selectComplaint(c.id));
                        markers.push(marker);
                    }
                }
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.active-tab').forEach(el => el.classList.remove('active-tab', 'border-b-2', 'border-blue-400', 'text-blue-400'));
            document.getElementById(`tab-${tab}`).classList.add('active-tab', 'border-b-2', 'border-blue-400', 'text-blue-400');
            renderList();
            closeDetails();
        }

        window.selectComplaint = function (id) {
            selectedId = id;
            renderList();
            const c = allComplaints.find(i => i.id === id);

            // Show details panel
            const panel = document.getElementById('detailsPanel');
            panel.classList.remove('translate-y-[120%]');

            // Fill Data
            document.getElementById('detailRoad').innerText = c.road_name || 'N/A';
            document.getElementById('detailLoc').innerText = c.location;
            document.getElementById('detailScore').innerText = c.priority_score.toFixed(1);
            document.getElementById('detailStatus').innerText = c.status;
            document.getElementById('detailPotholes').innerText = c.potholes ? c.potholes.length : 0;

            const vid = document.getElementById('detailVideo');
            const noVid = document.getElementById('noVideoMsg');
            if (c.video_path) {
                vid.src = `${API_URL}/${c.video_path}`; // Served via static
                vid.classList.remove('hidden');
                noVid.classList.add('hidden');
            } else {
                vid.src = '';
                vid.classList.add('hidden');
                noVid.classList.remove('hidden');
            }

            // Fly map
            if (c.location) {
                const [lat, lng] = c.location.split(',').map(Number);
                if (!isNaN(lat)) map.flyTo([lat, lng], 16);
            }
        };

        window.closeDetails = function () {
            document.getElementById('detailsPanel').classList.add('translate-y-[120%]');
            selectedId = null;
            renderList();
        };

        window.updateStatus = async function (status) {
            if (!selectedId) return;
            try {
                await API.updateStatus(selectedId, status);
                // Refresh
                allComplaints = await API.getAllComplaints();
                renderList();
                // Re-select to update UI
                selectComplaint(selectedId);
            } catch (err) {
                alert('Update failed');
            }
        }

        async function init() {
            initMap();
            try {
                allComplaints = await API.getAllComplaints();
                renderList();
            } catch (err) {
                console.error("Failed to load complaints");
            }
        }

        init();
    </script>
</body>

</html>